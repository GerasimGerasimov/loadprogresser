<p>Привет! Учусь front-end`у и параллельно в учебном проекте разрабатываю SPA на Vue.js для back-end`a который в свою очередь собирает данные от поискового бота. Бот нарабатывает от 0 до (около) 500 записей и я должен их: загрузить, отсортировать по заданным критериям, показать в таблице.</p>
<p>Так как ни back-end ни тем более бот, сортировать данные не умеют, мне приходятся загружать все данные и обрабатывать браузере. Сортировка происходит очень быстро, а вот скорость загрузки, зависит о коннекта, и указанные 500 записей могут загружаться от 10 до 40 секунд.</p>
<p>Я при загрузке показывал унылый спинер, недостаток которого - пользователь не знает когда закончится загрузка. В моём случае важно, что количество записей которые отыскал бот, заранее известно до загрузки, поэтому можно вычислять сколько % загружено.</p>
<p>Чтобы скрасить пользователю минуту ожидания я решил показать ему процесс загрузки. Идея такова, беру прямоугольный блок и:</p>
<ol>
    <li>цифрами отображаю сколько % записей уже загружено</li>
    <li>блок с лева на право, пропорционально % загруженного, заполняется графиком зависящим от времени загрузки каждой записи</li>
</ol>
<p>Определив цель, я приступил к реализации, и в итоге, на реальных данных, получил такую картину:</p>
<img src="https://habrastorage.org/webt/-o/wr/mc/-owrmchonzxft0kpoabdeumz2tm.gif" />
<p>
    ... по моему забавно, уж точно понятно что страница не зависла. 
</p>
<h3>Выбор способа отрисовки Canvas vs SVG</h3>
<p>Никогда не рисовал до селе графики в браузере, но до этого проекта, делал простую игру на JS с отрисовкой на <em>Canvas</em>, и выводил/масштабировал SVG-картинки вставленные на страницу в теге <em>object</em>. В данном проекте я не стал использовать <em>Canvas</em> из-за размытия изображения не кратного пикслям, в то время как у SVG графика чёткая при любых условиях.</p>
<h3>План работ</h3>
<p>С учётом выбранного фрймворка Vue.JS и выбранного способа формирования изображения с помощью SVG, составил себе следующий план работ:</p>
<ol>
    <li>Поиск и изучение информации по теме применения SVG совместно с Vue</li>
    <li>Эксперименты с формированием и изменением SVG в контексте Vue</li>
    <li>Создание прототипа индикатора загрузки</li>
    <li>Выделение индикатора загрузки в отдельный Vue-компонент</li>
    <li>Применение компонента в SPA</li>
</ol>
<h3>Приступаю к реализации</h3>
<ol>
    <li>
        <spoiler title="Создание заготовки проекта">
        <p>У меня установлен <em>vue cli</em>. Для создания нового проекта, в командной строке ввожу <em>vue create loadprogresser</em>, настройки проекта выбираю <em>default</em> создаётся новый vue-проект с названием loadprogresser, дальше убираю из него лишнее:</p>
        <table>
            <tr>
                <td align="center">Было</td>
                <td align="center">Стало</td>    
            </tr>
            <tr>
                <td valign="bottom" align="center">
                    <img src="https://habrastorage.org/webt/ff/dx/gz/ffdxgzse2s6oqmujajql_cz-qjc.png" width="25%"/>
                    <p>Структура проекта по default</p>
                </td>
                <td valign="bottom" align="center">
                    <img src="https://habrastorage.org/webt/ju/7o/xw/ju7oxwnd0bt6ygl47di54eyiccq.png" width="50%"/>
                    <p>Структура после "уборки"</p>
                </td>
            </tr>
            <tr>
                <td valign="bottom" align="center">
                    <img src="https://habrastorage.org/webt/db/vd/cz/dbvdczqbvxc4oi1mswth75ofpo0.png" width="50%"/>
                    <p>Приветствие от Vue</p>
                </td>
                <td valign="bottom" align="left">
                    <source>
<template>
  <div>
    <h1>Progresser</h1>
  </div>
</template>

<script>
  export default {name: 'app'}
</script>;                            
                    </source>
                    <p>Мой текст "Progresser" в App.vue</p>
                </td>
            </tr>
        </table>
        </spoiler>
    </li>
    <li>
        <h4>Поиск и изучение информации по теме применения SVG совместно с Vue</h4>
        <p>Хороший пример размещён в документации самого Vue <span><a href="https://ru.vuejs.org/v2/examples/svg.html">SVG-график Example</a></span><span><a href="http://jsfiddle.net/Vlad_IT/qt64rouL/1/"> и по такой ссылочке</a></span> на основе этих материалов родился минимальный шаблон компонента с SVG с которого я и стартую в компоненты с SVG:</p>
        <source>
<template>
  <div class="wrapper">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg"
        width="100%" height="100%"&gt; //svg заполняет весь контейнер
        //сюда буду вставлять svg-теги
    </svg>
  </div>
</template>
        </source>
    </li>
    <li>
        <h4>Эксперименты с формированием и изменением SVG в контексте Vue</h4>
        <h5>SVG Прямоугольник rect</h5>
            <p> rect - прямоугольник, самая простая фигура. Создаю svg с размерами 100х100px, и рисую прямоугольник rect с начальными координатами 25:25 и размерами 50х50 px, по умолчанию цвет заливки чёрный (нет стилизации)</p>
            <oembed>https://jsfiddle.net/Gerasim_v_Gerasimov/4wvp6ay1/</oembed>
        <h5>SVG стилизация и псевдоэлемент hover:</h5>
            <p>Попробую стилизовать прямоугольник rect в svg. Для этого к svg добавляю класс "sample", в секции style vue-файла добавляю стили .sample rect (раскрашиваю прямугольник rect жёлтым цветом) и .sample rect:hover который стилизует элемент rect при наведении на него курсора мыши:</p>
            <spoiler title="Исходник">
            <source lang="javascript">
<template>
    <div id="app">
        <svg class="sample" version="1.1" xmlns="http://www.w3.org/2000/svg" width="100px" height="100px">
            <rect x=25 y=25 width="50px" height="50px"/>
        </svg>
    </div>
</template>
                      
<script>                  
export default {
    name: 'app'
}
</script>
                      
<style>
.sample rect {
    fill: yellow;
    stroke: green;
    stroke-width: 4;
    transition: all 350ms;
}
                      
.sample rect:hover {
    fill: gray;
}
</style>            
</source>
            </spoiler>
            <spoiler title="Реализация на JSfiddle">
                <oembed>https://jsfiddle.net/Gerasim_v_Gerasimov/157o4nac/</oembed>
            </spoiler>
        <p>Вывод: svg отлично встраивается в template vue-файла и стилизуется прописанными стилями. Начало положено</p>
        <h5>SVG path как основа индикатора</h5>
        <p>В этом разделе я заменю rect на path, <code>&lt;path :d="D" class="path"/&gt;</code> в атрибут d тега path передам из vue строку D с координатами пути. Связь производится через <code>v-bind:d="D"</code>, что сокращённо записывается как <code>:d="D"</code> </p>
        <p>Строка D="M 0 0 0 50 50 50 50 0 Z" рисует три линии с координатами 0:0->0:50->50:50->0:50 и замыкает контур по команде Z, образуя квадрат 50х50px начинающийся из коодинат 0:0. С помощью стиля "path" фигуре придаётся жёлтый цвет заполнения и серая рамка в 1px.</p>
<spoiler title="Исходник жёлтого PATH">
<source lang="javascript">
    <template>
            <div id="app">
              <svg class="sample" version="1.1" xmlns="http://www.w3.org/2000/svg" width="100px" height="100px">
                    <path :d="D" class="path"/>
                </svg>
            </div>
          </template>
          <script>
          export default {
            name: 'app',
            data(){
              return {
                D:"M 0 0 0 50 50 50 50 0 Z"
              }
            }
          }
          </script>
          <style>
            .path {
              fill:yellow;
              stroke:gray;
            }
          </style>
</source>
</spoiler>
    </li>
    <li>
        <h4>Создание прототипа индикатора загрузки</h4>
        <p>В минимальном варианте, я сделал простую диаграмму. В шаблоне вставлен svg-контейнер высотой 100px, шириной 400px, внутри размещён тег path атрибуту d которого я добавляю сгенерированную строку-путь d из данных vue, которая в свою очередь формируется из массива timePoints куда добавляются каждые 10мс, 400 (по ширине контейнера)случайных числа в диапазоне от 0 до 100. Тут всё просто, в хуке жизненного цикла created, вызывается метод update в котором добавляются новые (случайные) точки в диаграмму через метод addTime, потом метод getSVGTimePoints возвращает строку для передачи в PATH, через setTimeout перезапускается метод update</p>
        <oembed>https://jsfiddle.net/Gerasim_v_Gerasimov/oku69hw1/</oembed>
        <p>Продолжу вносить изменения. Мой индикатор должен масштабироваться по ширине и высоте для того чтобы все переданные точки вписались в заданный контейнер. Для этого надо обратится к DOM и узнать размеры контейнера</p>
        <ol>
            <li>
                <h5>ref - получение информации о элементе DOM</h5>
                <p>DIV-ву контейнеру (в который вставлен svg) я добавляю класс wrapper чтобы передать ширину и высоту через стили. И чтобы svg занял всё пространство контейнера сделал высоту и ширину 100%, RECT, в свою очередь тоже займёт всё пространство контейнера и будет фоном для PATH </p>
                <source lang="html">
<div id="app" class="wrapper" ref="loadprogresser">
    <svg id="sample" version="1.1" xmlns="http://www.w3.org/2000/svg"
        width="100%" height="100%">
        <rect x=0 y=0 width="100%" height="100%"/>
        <path :d="d" fill="transparent" stroke="black"/>
    </svg>
</div>
                </source>
                <p>Для того чтобы найти мой DIV-контейнер в виртуальном DOM VUE, добавляю атрибут ref и присваиваю ему имя по которому буду осуществлять поиск <code>ref="loadprogresser"</code> в хуке жизненного цикла <code>mounted</code> где я вызову метод getScales(), в котором в свою очередь, строкой <code>const {width, height} = this.$refs.loadprogresser.getBoundingClientRect()</code> узнаю ширину и высоту DIV-элемента после его появления в DOM.</p>
                <p>Дальше простые расчёты приращения по оси Х зависящего от ширины контейнера и кол-ва точек которые хотим в него уместить. Масштаб по оси Y пересчитывается каждый раз при нахождении максимума в переданном значении.</p>
                <oembed>https://jsfiddle.net/Gerasim_v_Gerasimov/tf4dx3uj/</oembed>
            </li>
            <li><h5>transform - изменение системы координат</h5>
                <p>На этом этапе я замечаю, что надо бы изменить систему координат так, чтобы координата 0:0 начиналась из нижнего левого угла. Можно рассчитать каждую точку, но у нас SVG и в нём есть атрибут transform который позволяет трансформировать координаты</p>
                <p>В моём случае требуется применять к Y координатам масштаб -1, и сместить начало координат на минус высоту контейнера. Так как высота контейнера может быть любой, то пришлось формировать строку трансформации координат в хуке <code>mounted</code> таким кодом <code>this.transform = `scale( 1, -1) translate(0,${-this.wrapHeight})`</code> </p>
                <p>Но сама по себе трансформация применённая к PATH не сработает, для этого надо обернуть PATH в группу (тег g) к которой и применить трансформации координат:</p>
                <source lang="html">
<g :transform="transform">
    <path :d="d" fill="transparent" stroke="black"/>
</g>                
                </source>
                <p>В итоге координаты правильно развернулись, индикатор загрузки стал ближе к задуманному дизайну</p>
                <oembed>https://jsfiddle.net/Gerasim_v_Gerasimov/twarkc9q/</oembed>
            </li>
            <li><h5>SVG text и центрирование текста</h5>
                <p>Текст нужен для вывода % загрузки. Размещение текста в центре по вертикали и горизонтали в SVG довольно просто организовать (по сравнению с HTML/CSS), на помощь приходят атрибуты (сразу прописываю значения) dominant-baseline="central" и text-anchor="middle"</p>
                <p>Текст в SVG выводится соответствующим тегом</p>
                <code>&lt;text x="50%" y="50%" dominant-baseline="central" text-anchor="middle"&gt;{{TextPrc}}&lt;/text&gt;</code>
                <p>где TextPrc привязка к соответствующей переменной, вычисляемой по простому соотношению ожидаемого количества точек к переданному количеству <code>this.TextPrc = `${((this.Samples * 100)/this.maxSamples) | 0} %</code></p>
                <oembed>https://jsfiddle.net/Gerasim_v_Gerasimov/gjnpmutr/</oembed>
            </li>
        </ol>
        
    </li>
    <li>
        <h4>Выделение индикатора загрузки в отдельный Vue-компонент</h4>
        <p>Базу отработал, теперь надо выделять прототип индикатора в отдельный компонент. Для начала определюсь с данными которые буду передавать в компонет, это будут: maxSamples - кол-во сэмплов в 100%-ах ширины, и Point - единица данных (точка) которая будет внесена в массив точек (на основании которого, после обработки, сформируется график). Данные передаваемые компоненту от родителя, размещаю в секции props</p>
        <source lang="javascript">
props:{
    maxSamples: {//кол-во сэмплов в 100%-ах ширины
        type: Number,
        default: 400
    },
    Point:{//новая точка
        value:0
    }
}       
        </source>
        <h5>Проблемы с реактивностью</h5>
        <p>За то, что новая переданная в компонент точка будет обработана, отвечает   computed свойство getPath которое зависит от Point (а раз зависит, то и перевычисляется при изменении Point)</p>
        <source lang="javascript">
            //шаблон
            ...
            <path :d="getPath"/>
            ...
            //вычисляемое свойство
            computed:{
                getPath(){
                  this.addValue({value:this.Point.value})
                  return this.getSVGPoints()//this.d
                }
              },             
        </source>
        <p>Я сначала сделал Point типа Number, что логично, но тогда не все точки попадали в обработку, а только отличающиеся от предыдущих. Например, если из родителя передавать в такой Point только число 10, то на графике отрисуется только одна точка, все последующие будут проигнорированы так как они не отличаются от предыдущих.</p>
        <p>Замена типа Point с Number на объект {value:0} привело к желаемому результату - computed свойство getPath() теперь обрабатывает каждаю переданнаю точку, через Point.value передаю значения точек</p>
        <spoiler title="Исходник компонента Progresser.vue">
            <source lang="javascript">
            </source>
        </spoiler>
    </li>
    <li>
        <h4>Применение компонента в SPA</h4>
    </li>
</ol>
